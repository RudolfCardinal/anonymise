---
# yamllint disable rule:line-length
name: Docker
# yamllint disable-line rule:truthy
on:
    push:
        paths:
            - 'crate_anon/**'
            - .github/workflows/docker.yml
            - 'docker/**'
            - setup.py
jobs:
    docker:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2

            - name: Build
              # These are set in .env:
              # CRATE_DOCKER_CRATE_ANON_CONFIG=crate_anon_config.ini
              # CRATE_DOCKER_CRATEWEB_CONFIG_FILENAME=crateweb_local_settings.py
              # CRATE_DOCKER_CRATEWEB_HOST_PORT=8000
              # CRATE_DOCKER_CRATEWEB_USE_HTTPS=0
              # CRATE_DOCKER_CRATEWEB_SSL_CERTIFICATE=
              # CRATE_DOCKER_CRATEWEB_SSL_PRIVATE_KEY=
              # CRATE_DOCKER_FLOWER_HOST_PORT=5555
              # CRATE_DOCKER_MYSQL_CRATE_DATABASE_NAME=crate_web_db
              # CRATE_DOCKER_MYSQL_CRATE_USER_NAME=crate_web_user
              # CRATE_DOCKER_MYSQL_CRATE_HOST_PORT=3306

              run: |
                  set -euxo pipefail
                  export CRATE_DOCKER_CONFIG_HOST_DIR=${HOME}/crate_config
                  export CRATE_DOCKER_GATE_BIOYODIE_RESOURCES_HOST_DIR=${HOME}/bioyodie_resources
                  export CRATE_DOCKER_MYSQL_CRATE_USER_PASSWORD=ramalamadingdong
                  export CRATE_DOCKER_MYSQL_ROOT_PASSWORD=shoobydoobydoo
                  export CRATE_DOCKER_INSTALL_USER_ID=$(id -u)
                  export CRATE_DOCKER_INSTALL_GROUP_ID=$(id -g)
                  export CRATE_DOCKER_CRATEWEB_USE_HTTPS=0
                  cd docker/dockerfiles
                  docker-compose version
                  docker-compose build
