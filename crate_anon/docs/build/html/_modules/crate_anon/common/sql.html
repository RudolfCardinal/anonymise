
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>crate_anon.common.sql &#8212; CRATE  documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/crate_docs.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for crate_anon.common.sql</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># crate_anon/common/sql.py</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===============================================================================</span>

<span class="sd">    Copyright (C) 2015-2018 Rudolf Cardinal (rudolf@pobox.com).</span>

<span class="sd">    This file is part of CRATE.</span>

<span class="sd">    CRATE is free software: you can redistribute it and/or modify</span>
<span class="sd">    it under the terms of the GNU General Public License as published by</span>
<span class="sd">    the Free Software Foundation, either version 3 of the License, or</span>
<span class="sd">    (at your option) any later version.</span>

<span class="sd">    CRATE is distributed in the hope that it will be useful,</span>
<span class="sd">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="sd">    GNU General Public License for more details.</span>

<span class="sd">    You should have received a copy of the GNU General Public License</span>
<span class="sd">    along with CRATE. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="sd">===============================================================================</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">cardinal_pythonlib.json.serialize</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">METHOD_PROVIDES_INIT_KWARGS</span><span class="p">,</span>
    <span class="n">METHOD_STRIP_UNDERSCORE</span><span class="p">,</span>
    <span class="n">register_for_json</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.lists</span> <span class="k">import</span> <span class="n">unique_list</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.logs</span> <span class="k">import</span> <span class="n">main_only_quicksetup_rootlogger</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.reprfunc</span> <span class="k">import</span> <span class="n">mapped_repr_stripping_underscores</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sizeformatter</span> <span class="k">import</span> <span class="n">sizeof_fmt</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sql.literals</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">sql_date_literal</span><span class="p">,</span>
    <span class="n">sql_string_literal</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sql.sql_grammar</span> <span class="k">import</span> <span class="n">SqlGrammar</span><span class="p">,</span> <span class="n">text_from_parsed</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sql.sql_grammar_factory</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">make_grammar</span><span class="p">,</span>
    <span class="n">mysql_grammar</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.core_query</span> <span class="k">import</span> <span class="n">count_star</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.dialect</span> <span class="k">import</span> <span class="n">SqlaDialectName</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.sqlalchemy.schema</span> <span class="k">import</span> <span class="n">column_creation_ddl</span>
<span class="kn">from</span> <span class="nn">cardinal_pythonlib.timing</span> <span class="k">import</span> <span class="n">MultiTimerContext</span><span class="p">,</span> <span class="n">timer</span>
<span class="kn">from</span> <span class="nn">pyparsing</span> <span class="k">import</span> <span class="n">ParseResults</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">inspect</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.mssql.base</span> <span class="k">import</span> <span class="n">MS_2012_VERSION</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine.base</span> <span class="k">import</span> <span class="n">Engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine.interfaces</span> <span class="k">import</span> <span class="n">Dialect</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.session</span> <span class="k">import</span> <span class="n">Session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="k">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span>

<span class="kn">from</span> <span class="nn">crate_anon.common.stringfunc</span> <span class="k">import</span> <span class="n">get_spec_match_regex</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Types</span>
<span class="c1"># =============================================================================</span>

<span class="n">SqlArgsTupleType</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Constants</span>
<span class="c1"># =============================================================================</span>

<span class="n">TIMING_COMMIT</span> <span class="o">=</span> <span class="s2">&quot;commit&quot;</span>

<span class="n">SQL_OPS_VALUE_UNNECESSARY</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IS NULL&#39;</span><span class="p">,</span> <span class="s1">&#39;IS NOT NULL&#39;</span><span class="p">]</span>
<span class="n">SQL_OPS_MULTIPLE_VALUES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;IN&#39;</span><span class="p">,</span> <span class="s1">&#39;NOT IN&#39;</span><span class="p">]</span>

<span class="n">SQLTYPES_INTEGER</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;INT&quot;</span><span class="p">,</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TINYINT&quot;</span><span class="p">,</span> <span class="s2">&quot;SMALLINT&quot;</span><span class="p">,</span> <span class="s2">&quot;MEDIUMINT&quot;</span><span class="p">,</span> <span class="s2">&quot;BIGINT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;BIT&quot;</span><span class="p">,</span> <span class="s2">&quot;BOOL&quot;</span><span class="p">,</span> <span class="s2">&quot;BOOLEAN&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">SQLTYPES_FLOAT</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;DOUBLE&quot;</span><span class="p">,</span> <span class="s2">&quot;FLOAT&quot;</span><span class="p">,</span> <span class="s2">&quot;DEC&quot;</span><span class="p">,</span> <span class="s2">&quot;DECIMAL&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">SQLTYPES_TEXT</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;CHAR&quot;</span><span class="p">,</span> <span class="s2">&quot;VARCHAR&quot;</span><span class="p">,</span> <span class="s2">&quot;NVARCHAR&quot;</span><span class="p">,</span>
    <span class="s2">&quot;TINYTEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;NTEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;MEDIUMTEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;LONGTEXT&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">SQLTYPES_WITH_DATE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;DATE&quot;</span><span class="p">,</span> <span class="s2">&quot;DATETIME&quot;</span><span class="p">,</span> <span class="s2">&quot;TIMESTAMP&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="c1"># SQLTYPES_BINARY = [</span>
<span class="c1">#     &quot;BINARY&quot;, &quot;BLOB&quot;, &quot;IMAGE&quot;, &quot;LONGBLOB&quot;, &quot;VARBINARY&quot;,</span>
<span class="c1"># ]</span>

<span class="c1"># Must match querybuilder.js:</span>
<span class="n">QB_DATATYPE_INTEGER</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
<span class="n">QB_DATATYPE_FLOAT</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span>
<span class="n">QB_DATATYPE_DATE</span> <span class="o">=</span> <span class="s2">&quot;date&quot;</span>
<span class="n">QB_DATATYPE_STRING</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
<span class="n">QB_DATATYPE_STRING_FULLTEXT</span> <span class="o">=</span> <span class="s2">&quot;string_fulltext&quot;</span>
<span class="n">QB_DATATYPE_UNKNOWN</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>
<span class="n">QB_STRING_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="n">QB_DATATYPE_STRING</span><span class="p">,</span> <span class="n">QB_DATATYPE_STRING_FULLTEXT</span><span class="p">]</span>

<span class="n">COLTYPE_WITH_ONE_INTEGER_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^([A-z]+)\((\d+)\)$&quot;</span><span class="p">)</span>
<span class="c1"># ... start, group(alphabetical), literal (, group(digit), literal ), end</span>


<span class="c1"># def combine_db_schema_table(db: Optional[str],</span>
<span class="c1">#                             schema: Optional[str],</span>
<span class="c1">#                             table: str) -&gt; str:</span>
<span class="c1">#     # ANSI SQL: http://www.contrib.andrew.cmu.edu/~shadow/sql/sql1992.txt</span>
<span class="c1">#     # &lt;table name&gt;, &lt;qualified name&gt;</span>
<span class="c1">#     if not table:</span>
<span class="c1">#         raise ValueError(&quot;Missing table supplied to combine_db_schema_table&quot;)</span>
<span class="c1">#     return &quot;.&quot;.join(x for x in [db, schema, table] if x)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># SQL elements: identifiers</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@register_for_json</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">METHOD_STRIP_UNDERSCORE</span><span class="p">)</span>
<span class="nd">@functools</span><span class="o">.</span><span class="n">total_ordering</span>
<span class="k">class</span> <span class="nc">SchemaId</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">db</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Bad database name (</span><span class="si">{!r}</span><span class="s2">); can&#39;t include &#39;.&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">assert</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">,</span> <span class="p">(</span>
            <span class="s2">&quot;Bad schema name (</span><span class="si">{!r}</span><span class="s2">); can&#39;t include &#39;.&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String suitable for encoding the SchemaId e.g. in a single HTML form.</span>
<span class="sd">        The __init__ function checks the assumption of no &#39;.&#39; characters in</span>
<span class="sd">        either part.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_schema_tag</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SchemaId&#39;</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;Bad schema tag </span><span class="si">{!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">db</span><span class="p">,</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">parts</span>
        <span class="k">return</span> <span class="n">SchemaId</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;SchemaId&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>  <span class="c1"># ordering is for speed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_schema</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_db</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;SchemaId&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span> <span class="o">&lt;</span>
            <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span>
                               <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
                               <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">table_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;TableId&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TableId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">column_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ColumnId&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ColumnId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span>
                        <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">mysql_grammar</span><span class="p">)</span>  <span class="c1"># specific one unimportant</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mapped_repr_stripping_underscores</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_db&#39;</span><span class="p">,</span> <span class="s1">&#39;_schema&#39;</span><span class="p">])</span>


<span class="nd">@register_for_json</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">METHOD_STRIP_UNDERSCORE</span><span class="p">)</span>
<span class="nd">@functools</span><span class="o">.</span><span class="n">total_ordering</span>
<span class="k">class</span> <span class="nc">TableId</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">table</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;TableId&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>  <span class="c1"># ordering is for speed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_table</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_schema</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_db</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;TableId&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span> <span class="o">&lt;</span>
            <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span>
                               <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
                               <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span>
                               <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SchemaId</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SchemaId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">column_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;ColumnId&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ColumnId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span>
                        <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">database_schema_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span>
                               <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
                               <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">table_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">mysql_grammar</span><span class="p">)</span>  <span class="c1"># specific one unimportant</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mapped_repr_stripping_underscores</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_db&#39;</span><span class="p">,</span> <span class="s1">&#39;_schema&#39;</span><span class="p">,</span> <span class="s1">&#39;_table&#39;</span><span class="p">])</span>


<span class="nd">@register_for_json</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">METHOD_STRIP_UNDERSCORE</span><span class="p">)</span>
<span class="nd">@functools</span><span class="o">.</span><span class="n">total_ordering</span>
<span class="k">class</span> <span class="nc">ColumnId</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">db</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column</span> <span class="o">=</span> <span class="n">column</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_column</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;ColumnId&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_column</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_column</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_table</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_schema</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_db</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;ColumnId&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column</span><span class="p">)</span> <span class="o">&lt;</span>
            <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_column</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column</span><span class="p">)</span>  <span class="c1"># the minimum</span>

    <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">,</span>
                               <span class="n">database</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span>
                               <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span>
                               <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">,</span>
                               <span class="n">column</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_column</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schema</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_table</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schema_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SchemaId</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SchemaId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableId</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">TableId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_table_and_column</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_table</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">mysql_grammar</span><span class="p">)</span>  <span class="c1"># specific one unimportant</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mapped_repr_stripping_underscores</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_db&#39;</span><span class="p">,</span> <span class="s1">&#39;_schema&#39;</span><span class="p">,</span> <span class="s1">&#39;_table&#39;</span><span class="p">,</span> <span class="s1">&#39;_column&#39;</span><span class="p">])</span>

    <span class="c1"># def html(self, grammar: SqlGrammar, bold_column: bool = True) -&gt; str:</span>
    <span class="c1">#     components = [</span>
    <span class="c1">#         html.escape(grammar.quote_identifier_if_required(x))</span>
    <span class="c1">#         for x in [self._db, self._schema, self._table, self._column]</span>
    <span class="c1">#         if x]</span>
    <span class="c1">#     if not components:</span>
    <span class="c1">#         return &#39;&#39;</span>
    <span class="c1">#     if bold_column:</span>
    <span class="c1">#         components[-1] = &quot;&lt;b&gt;{}&lt;/b&gt;&quot;.format(components[-1])</span>
    <span class="c1">#     return &quot;.&quot;.join(components)</span>


<span class="k">def</span> <span class="nf">split_db_schema_table</span><span class="p">(</span><span class="n">db_schema_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableId</span><span class="p">:</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">db_schema_table</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># db.schema.table</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># schema.table</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># table</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad db_schema_table: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">db_schema_table</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">TableId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">split_db_schema_table_column</span><span class="p">(</span><span class="n">db_schema_table_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnId</span><span class="p">:</span>
    <span class="n">components</span> <span class="o">=</span> <span class="n">db_schema_table_col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># db.schema.table.column</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># schema.table.column</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># table.column</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># column</span>
        <span class="n">d</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bad db_schema_table_col: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">db_schema_table_col</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ColumnId</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">column</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">columns_to_table_column_hierarchy</span><span class="p">(</span>
        <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ColumnId</span><span class="p">],</span>
        <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">TableId</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">ColumnId</span><span class="p">]]]:</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="n">unique_list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">table_id</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">tables</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">table_column_map</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="n">t_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">table_id</span> <span class="o">==</span> <span class="n">t</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">t_columns</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">table_column_map</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">t_columns</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">table_column_map</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Using SQL grammars (but without reference to Django models, for testing)</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">make_identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">,</span>
                    <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">grammar</span><span class="o">.</span><span class="n">quote_identifier_if_required</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">elements</span><span class="p">,</span> <span class="s2">&quot;make_identifier(): No elements passed!&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dumb_make_identifier</span><span class="p">(</span><span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">database</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="p">])</span>
    <span class="k">assert</span> <span class="n">elements</span><span class="p">,</span> <span class="s2">&quot;make_identifier(): No elements passed!&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parser_add_result_column</span><span class="p">(</span><span class="n">parsed</span><span class="p">:</span> <span class="n">ParseResults</span><span class="p">,</span>
                             <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParseResults</span><span class="p">:</span>
    <span class="c1"># Presupposes at least one column already in the SELECT statement.</span>
    <span class="c1"># log.critical(&quot;Adding: &quot; + repr(column))</span>
    <span class="n">existing_columns</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">select_expression</span><span class="o">.</span><span class="n">select_columns</span><span class="o">.</span><span class="n">asList</span><span class="p">()</span>
    <span class="c1"># log.critical(parsed.dump())</span>
    <span class="c1"># log.critical(&quot;existing columns: {}&quot;.format(repr(existing_columns)))</span>
    <span class="c1"># log.critical(&quot;adding column: {}&quot;.format(column))</span>
    <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_columns</span><span class="p">:</span>
        <span class="c1"># log.critical(&quot;... doesn&#39;t exist; adding&quot;)</span>
        <span class="n">newcol</span> <span class="o">=</span> <span class="n">grammar</span><span class="o">.</span><span class="n">get_result_column</span><span class="p">()</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">column</span><span class="p">,</span>
                                                         <span class="n">parseAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># log.critical(&quot;... &quot; + repr(newcol))</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">select_expression</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">newcol</span><span class="p">])</span>
    <span class="c1"># else:</span>
    <span class="c1">#     log.critical(&quot;... skipping column; exists&quot;)</span>
    <span class="c1"># log.critical(parsed.dump())</span>
    <span class="k">return</span> <span class="n">parsed</span>


<span class="k">class</span> <span class="nc">JoinInfo</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">join_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;INNER JOIN&#39;</span><span class="p">,</span>
                 <span class="n">join_condition</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># e.g. &quot;ON x = y&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_type</span> <span class="o">=</span> <span class="n">join_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join_condition</span> <span class="o">=</span> <span class="n">join_condition</span>


<div class="viewcode-block" id="parser_add_from_tables"><a class="viewcode-back" href="../../../autodoc/common/sql.html#crate_anon.common.sql.parser_add_from_tables">[docs]</a><span class="k">def</span> <span class="nf">parser_add_from_tables</span><span class="p">(</span><span class="n">parsed</span><span class="p">:</span> <span class="n">ParseResults</span><span class="p">,</span>
                           <span class="n">join_info_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">JoinInfo</span><span class="p">],</span>
                           <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParseResults</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    joininfo: list of dictionaries with keys:</span>
<span class="sd">        table, join_type, join_condition</span>
<span class="sd">    Presupposes at least one table already in the FROM clause.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># log.critical(parsed.dump())</span>
    <span class="n">existing_tables</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">join_source</span><span class="o">.</span><span class="n">from_tables</span><span class="o">.</span><span class="n">asList</span><span class="p">()</span>
    <span class="c1"># log.critical(&quot;existing tables: {}&quot;.format(existing_tables))</span>
    <span class="c1"># log.critical(&quot;adding table: {}&quot;.format(table))</span>
    <span class="k">for</span> <span class="n">ji</span> <span class="ow">in</span> <span class="n">join_info_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ji</span><span class="o">.</span><span class="n">table</span> <span class="ow">in</span> <span class="n">existing_tables</span><span class="p">:</span>  <span class="c1"># already there</span>
            <span class="c1"># log.critical(&quot;field already present&quot;)</span>
            <span class="k">continue</span>
        <span class="n">parsed_join</span> <span class="o">=</span> <span class="n">grammar</span><span class="o">.</span><span class="n">get_join_op</span><span class="p">()</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">ji</span><span class="o">.</span><span class="n">join_type</span><span class="p">,</span>
                                                        <span class="n">parseAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># e.g. INNER JOIN  # noqa</span>
        <span class="n">parsed_table</span> <span class="o">=</span> <span class="n">grammar</span><span class="o">.</span><span class="n">get_table_spec</span><span class="p">()</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">ji</span><span class="o">.</span><span class="n">table</span><span class="p">,</span>
                                                            <span class="n">parseAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">extrabits</span> <span class="o">=</span> <span class="p">[</span><span class="n">parsed_join</span><span class="p">,</span> <span class="n">parsed_table</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ji</span><span class="o">.</span><span class="n">join_condition</span><span class="p">:</span>  <span class="c1"># e.g. ON x = y</span>
            <span class="n">extrabits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">grammar</span><span class="o">.</span><span class="n">get_join_constraint</span><span class="p">()</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">ji</span><span class="o">.</span><span class="n">join_condition</span><span class="p">,</span>
                                                          <span class="n">parseAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">parsed</span><span class="o">.</span><span class="n">join_source</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extrabits</span><span class="p">)</span>
    <span class="c1"># log.critical(parsed.dump())</span>
    <span class="k">return</span> <span class="n">parsed</span></div>


<div class="viewcode-block" id="get_first_from_table"><a class="viewcode-back" href="../../../autodoc/common/sql.html#crate_anon.common.sql.get_first_from_table">[docs]</a><span class="k">def</span> <span class="nf">get_first_from_table</span><span class="p">(</span><span class="n">parsed</span><span class="p">:</span> <span class="n">ParseResults</span><span class="p">,</span>
                         <span class="n">match_db</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                         <span class="n">match_schema</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                         <span class="n">match_table</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableId</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a set of parsed results from a SELECT statement,</span>
<span class="sd">    returns the (db, schema, table) tuple</span>
<span class="sd">    representing the first table in the FROM clause.</span>

<span class="sd">    Optionally, the match may be constrained with the match* parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">existing_tables</span> <span class="o">=</span> <span class="n">parsed</span><span class="o">.</span><span class="n">join_source</span><span class="o">.</span><span class="n">from_tables</span><span class="o">.</span><span class="n">asList</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">existing_tables</span><span class="p">:</span>
        <span class="n">table_id</span> <span class="o">=</span> <span class="n">split_db_schema_table</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match_db</span> <span class="ow">and</span> <span class="n">table_id</span><span class="o">.</span><span class="n">db</span> <span class="o">!=</span> <span class="n">match_db</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">match_schema</span> <span class="ow">and</span> <span class="n">table_id</span><span class="o">.</span><span class="n">schema</span> <span class="o">!=</span> <span class="n">match_schema</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">match_table</span> <span class="ow">and</span> <span class="n">table_id</span><span class="o">.</span><span class="n">table</span> <span class="o">!=</span> <span class="n">match_table</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">return</span> <span class="n">table_id</span>
    <span class="k">return</span> <span class="n">TableId</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">set_distinct_within_parsed</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">ParseResults</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;set&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">select_specifier</span>  <span class="c1"># type: ParseResults</span>
    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;DISTINCT&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">asList</span><span class="p">():</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;DISTINCT&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;clear&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;DISTINCT&#39;</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">asList</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">ss</span><span class="p">[:]</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;toggle&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;DISTINCT&#39;</span> <span class="ow">in</span> <span class="n">ss</span><span class="o">.</span><span class="n">asList</span><span class="p">():</span>
            <span class="k">del</span> <span class="n">ss</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;DISTINCT&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;action must be one of set/clear/toggle&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">set_distinct</span><span class="p">(</span><span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">,</span>
                 <span class="n">action</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span>
                 <span class="n">formatted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">debug_verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">grammar</span><span class="o">.</span><span class="n">get_select_statement</span><span class="p">()</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">parseAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;START: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sql</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">debug_verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;start dump:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>
    <span class="n">set_distinct_within_parsed</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">text_from_parsed</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">formatted</span><span class="o">=</span><span class="n">formatted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;END: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">debug_verbose</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;end dump:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">toggle_distinct</span><span class="p">(</span><span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">,</span>
                    <span class="n">formatted</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">debug_verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">set_distinct</span><span class="p">(</span><span class="n">sql</span><span class="o">=</span><span class="n">sql</span><span class="p">,</span>
                        <span class="n">grammar</span><span class="o">=</span><span class="n">grammar</span><span class="p">,</span>
                        <span class="n">action</span><span class="o">=</span><span class="s1">&#39;toggle&#39;</span><span class="p">,</span>
                        <span class="n">formatted</span><span class="o">=</span><span class="n">formatted</span><span class="p">,</span>
                        <span class="n">debug</span><span class="o">=</span><span class="n">debug</span><span class="p">,</span>
                        <span class="n">debug_verbose</span><span class="o">=</span><span class="n">debug_verbose</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># SQLAlchemy reflection and DDL</span>
<span class="c1"># =============================================================================</span>

<span class="n">_print_not_execute</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">set_print_not_execute</span><span class="p">(</span><span class="n">print_not_execute</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">global</span> <span class="n">_print_not_execute</span>
    <span class="n">_print_not_execute</span> <span class="o">=</span> <span class="n">print_not_execute</span>


<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_print_not_execute</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">format_sql_for_print</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">;&quot;</span><span class="p">)</span>
        <span class="c1"># extra \n in case the SQL ends in a comment</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_columns</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Column</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">existing_column_names</span> <span class="o">=</span> <span class="n">get_column_names</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="n">to_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">column_defs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_column_names</span><span class="p">:</span>
            <span class="n">column_defs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_creation_ddl</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2">: column </span><span class="si">{}</span><span class="s2"> already exists; not adding&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
    <span class="c1"># ANSI SQL: add one column at a time: ALTER TABLE ADD [COLUMN] coldef</span>
    <span class="c1">#   - i.e. &quot;COLUMN&quot; optional, one at a time, no parentheses</span>
    <span class="c1">#   - http://www.contrib.andrew.cmu.edu/~shadow/sql/sql1992.txt</span>
    <span class="c1"># MySQL: ALTER TABLE ADD [COLUMN] (a INT, b VARCHAR(32));</span>
    <span class="c1">#   - i.e. &quot;COLUMN&quot; optional, parentheses required for &gt;1, multiple OK</span>
    <span class="c1">#   - http://dev.mysql.com/doc/refman/5.7/en/alter-table.html</span>
    <span class="c1"># MS SQL Server: ALTER TABLE ADD COLUMN a INT, B VARCHAR(32);</span>
    <span class="c1">#   - i.e. no &quot;COLUMN&quot;, no parentheses, multiple OK</span>
    <span class="c1">#   - https://msdn.microsoft.com/en-us/library/ms190238.aspx</span>
    <span class="c1">#   - https://msdn.microsoft.com/en-us/library/ms190273.aspx</span>
    <span class="c1">#   - http://stackoverflow.com/questions/2523676</span>
    <span class="c1"># SQLAlchemy doesn&#39;t provide a shortcut for this.</span>
    <span class="k">for</span> <span class="n">column_def</span> <span class="ow">in</span> <span class="n">column_defs</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2">: adding column </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">repr</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">column_def</span><span class="p">)))</span>
        <span class="n">execute</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            ALTER TABLE </span><span class="si">{tablename}</span><span class="s2"> ADD </span><span class="si">{column_def}</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">column_def</span><span class="o">=</span><span class="n">column_def</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">drop_columns</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                 <span class="n">column_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">existing_column_names</span> <span class="o">=</span> <span class="n">get_column_names</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="n">to_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_column_names</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2">: column </span><span class="si">{}</span><span class="s2"> does not exist; not &quot;</span>
                      <span class="s2">&quot;dropping&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2">: dropping column </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
            <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;ALTER TABLE </span><span class="si">{t}</span><span class="s2"> DROP COLUMN </span><span class="si">{c}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                           <span class="n">c</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># SQL Server:</span>
            <span class="c1">#   http://www.techonthenet.com/sql_server/tables/alter_table.php</span>
            <span class="c1"># MySQL:</span>
            <span class="c1">#   http://dev.mysql.com/doc/refman/5.7/en/alter-table.html</span>
            <span class="n">execute</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">add_indexes</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                <span class="n">indexdictlist</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">existing_index_names</span> <span class="o">=</span> <span class="n">get_index_names</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                           <span class="n">to_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">idxdefdict</span> <span class="ow">in</span> <span class="n">indexdictlist</span><span class="p">:</span>
        <span class="n">index_name</span> <span class="o">=</span> <span class="n">idxdefdict</span><span class="p">[</span><span class="s1">&#39;index_name&#39;</span><span class="p">]</span>
        <span class="n">column</span> <span class="o">=</span> <span class="n">idxdefdict</span><span class="p">[</span><span class="s1">&#39;column&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">column</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>  <span class="c1"># must be a list</span>
        <span class="n">unique</span> <span class="o">=</span> <span class="n">idxdefdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unique&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_index_names</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2">: adding index </span><span class="si">{}</span><span class="s2"> on column </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">index_name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">column</span><span class="p">)))</span>
            <span class="n">execute</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE</span><span class="si">{unique}</span><span class="s2"> INDEX </span><span class="si">{idxname}</span><span class="s2"> ON </span><span class="si">{tablename}</span><span class="s2"> (</span><span class="si">{column}</span><span class="s2">)</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">unique</span><span class="o">=</span><span class="s2">&quot; UNIQUE&quot;</span> <span class="k">if</span> <span class="n">unique</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">idxname</span><span class="o">=</span><span class="n">index_name</span><span class="p">,</span>
                <span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">column</span><span class="o">=</span><span class="n">column</span><span class="p">,</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2">: index </span><span class="si">{}</span><span class="s2"> already exists; not adding&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">index_name</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">drop_indexes</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Table</span><span class="p">,</span>
                 <span class="n">index_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">existing_index_names</span> <span class="o">=</span> <span class="n">get_index_names</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                           <span class="n">to_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="n">index_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">index_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_index_names</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2">: index </span><span class="si">{}</span><span class="s2"> does not exist; not dropping&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">index_name</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Table </span><span class="si">{}</span><span class="s2">: dropping index </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">index_name</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mysql&#39;</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;ALTER TABLE </span><span class="si">{t}</span><span class="s2"> DROP INDEX </span><span class="si">{i}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                              <span class="n">i</span><span class="o">=</span><span class="n">index_name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mssql&#39;</span><span class="p">:</span>
                <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;DROP INDEX </span><span class="si">{t}</span><span class="s2">.</span><span class="si">{i}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">index_name</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Unknown dialect: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">execute</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_table_names</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
                    <span class="n">to_lower</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">inspector</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">table_names</span> <span class="o">=</span> <span class="n">inspector</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">to_lower</span><span class="p">:</span>
        <span class="n">table_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">table_names</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">table_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">table_names</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">table_names</span>


<span class="k">def</span> <span class="nf">get_view_names</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
                   <span class="n">to_lower</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                   <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">inspector</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">view_names</span> <span class="o">=</span> <span class="n">inspector</span><span class="o">.</span><span class="n">get_view_names</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">to_lower</span><span class="p">:</span>
        <span class="n">view_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">view_names</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">view_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">view_names</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">view_names</span>


<div class="viewcode-block" id="get_column_names"><a class="viewcode-back" href="../../../autodoc/common/sql.html#crate_anon.common.sql.get_column_names">[docs]</a><span class="k">def</span> <span class="nf">get_column_names</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
                     <span class="n">tablename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">to_lower</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads columns names afresh from the database (in case metadata is out of</span>
<span class="sd">    date).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inspector</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">inspector</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">to_lower</span><span class="p">:</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">column_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">column_names</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">column_names</span></div>


<div class="viewcode-block" id="get_index_names"><a class="viewcode-back" href="../../../autodoc/common/sql.html#crate_anon.common.sql.get_index_names">[docs]</a><span class="k">def</span> <span class="nf">get_index_names</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
                    <span class="n">tablename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">to_lower</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads index names from the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># http://docs.sqlalchemy.org/en/latest/core/reflection.html</span>
    <span class="n">inspector</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="n">inspector</span><span class="o">.</span><span class="n">get_indexes</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span>
    <span class="n">index_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">indexes</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span>
    <span class="c1"># ... at least for SQL Server, there always seems to be a blank one</span>
    <span class="c1"># with {&#39;name&#39;: None, ...}.</span>
    <span class="k">if</span> <span class="n">to_lower</span><span class="p">:</span>
        <span class="n">index_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">index_names</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">index_names</span></div>


<span class="k">def</span> <span class="nf">ensure_columns_present</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
                           <span class="n">tablename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">column_names</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">existing_column_names</span> <span class="o">=</span> <span class="n">get_column_names</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="n">tablename</span><span class="p">,</span>
                                             <span class="n">to_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">column_names</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_column_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Column </span><span class="si">{}</span><span class="s2"> missing from table </span><span class="si">{}</span><span class="s2">, whose columns are </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">repr</span><span class="p">(</span><span class="n">col</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">tablename</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">existing_column_names</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">create_view</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
                <span class="n">viewname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="n">select_sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mysql&#39;</span><span class="p">:</span>
        <span class="c1"># MySQL has CREATE OR REPLACE VIEW.</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;CREATE OR REPLACE VIEW </span><span class="si">{viewname}</span><span class="s2"> AS </span><span class="si">{select_sql}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">viewname</span><span class="o">=</span><span class="n">viewname</span><span class="p">,</span>
            <span class="n">select_sql</span><span class="o">=</span><span class="n">select_sql</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># SQL Server doesn&#39;t: http://stackoverflow.com/questions/18534919</span>
        <span class="n">drop_view</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">viewname</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;CREATE VIEW </span><span class="si">{viewname}</span><span class="s2"> AS </span><span class="si">{select_sql}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">viewname</span><span class="o">=</span><span class="n">viewname</span><span class="p">,</span>
            <span class="n">select_sql</span><span class="o">=</span><span class="n">select_sql</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating view: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">viewname</span><span class="p">)))</span>
    <span class="n">execute</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">assert_view_has_same_num_rows</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
                                  <span class="n">basetable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                  <span class="n">viewname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># Note that this relies on the data, i.e. design failures MAY cause this</span>
    <span class="c1"># assertion to fail, but won&#39;t necessarily (e.g. if the table is empty).</span>
    <span class="n">n_base</span> <span class="o">=</span> <span class="n">count_star</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">basetable</span><span class="p">)</span>
    <span class="n">n_view</span> <span class="o">=</span> <span class="n">count_star</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">viewname</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">n_view</span> <span class="o">==</span> <span class="n">n_base</span><span class="p">,</span> <span class="p">(</span>
        <span class="s2">&quot;View bug: view </span><span class="si">{}</span><span class="s2"> has </span><span class="si">{}</span><span class="s2"> records but its base table </span><span class="si">{}</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;has </span><span class="si">{}</span><span class="s2">; they should be equal&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">viewname</span><span class="p">,</span> <span class="n">n_view</span><span class="p">,</span>
            <span class="n">basetable</span><span class="p">,</span> <span class="n">n_base</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">drop_view</span><span class="p">(</span><span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
              <span class="n">viewname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
              <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># MySQL has DROP VIEW IF EXISTS, but SQL Server only has that from</span>
    <span class="c1"># SQL Server 2016 onwards.</span>
    <span class="c1"># - https://msdn.microsoft.com/en-us/library/ms173492.aspx</span>
    <span class="c1"># - http://dev.mysql.com/doc/refman/5.7/en/drop-view.html</span>
    <span class="n">view_names</span> <span class="o">=</span> <span class="n">get_view_names</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">to_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">viewname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">view_names</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;View </span><span class="si">{}</span><span class="s2"> does not exist; not dropping&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">viewname</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dropping view: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">viewname</span><span class="p">)))</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;DROP VIEW </span><span class="si">{viewname}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">viewname</span><span class="o">=</span><span class="n">viewname</span><span class="p">)</span>
        <span class="n">execute</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">sql</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># View-building assistance class</span>
<span class="c1"># =============================================================================</span>

<span class="k">class</span> <span class="nc">ViewMaker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">viewname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">,</span>
                 <span class="n">basetable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">existing_to_lower</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">rename</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">progargs</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">enforce_same_n_rows_as_base</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">insert_basetable_columns</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rename</span> <span class="o">=</span> <span class="n">rename</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="k">assert</span> <span class="n">basetable</span><span class="p">,</span> <span class="s2">&quot;ViewMaker: basetable missing!&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewname</span> <span class="o">=</span> <span class="n">viewname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">engine</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basetable</span> <span class="o">=</span> <span class="n">basetable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progargs</span> <span class="o">=</span> <span class="n">progargs</span>  <span class="c1"># only for others&#39; benefit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enforce_same_n_rows_as_base</span> <span class="o">=</span> <span class="n">enforce_same_n_rows_as_base</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">basetable</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where_elements</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup_tables</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_requests</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">insert_basetable_columns</span><span class="p">:</span>
            <span class="n">grammar</span> <span class="o">=</span> <span class="n">make_grammar</span><span class="p">(</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">q</span><span class="p">(</span><span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">grammar</span><span class="o">.</span><span class="n">quote_identifier_if_required</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">get_column_names</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">tablename</span><span class="o">=</span><span class="n">basetable</span><span class="p">,</span>
                                            <span class="n">to_lower</span><span class="o">=</span><span class="n">existing_to_lower</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">colname</span> <span class="ow">in</span> <span class="n">rename</span><span class="p">:</span>
                    <span class="n">rename_to</span> <span class="o">=</span> <span class="n">rename</span><span class="p">[</span><span class="n">colname</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">rename_to</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">as_clause</span> <span class="o">=</span> <span class="s2">&quot; AS </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="p">(</span><span class="n">rename_to</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">as_clause</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">select_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{t}</span><span class="s2">.</span><span class="si">{c}{as_clause}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">t</span><span class="o">=</span><span class="n">q</span><span class="p">(</span><span class="n">basetable</span><span class="p">),</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">q</span><span class="p">(</span><span class="n">colname</span><span class="p">),</span>
                    <span class="n">as_clause</span><span class="o">=</span><span class="n">as_clause</span><span class="p">))</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_elements</span><span class="p">,</span> <span class="s2">&quot;Must have some active SELECT &quot;</span> \
                                         <span class="s2">&quot;elements from base table&quot;</span>

    <span class="k">def</span> <span class="nf">add_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clause</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">from_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clause</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_where</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clause</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">where_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clause</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_elements</span><span class="p">,</span> <span class="s2">&quot;ViewMaker: no SELECT elements!&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">where_elements</span><span class="p">:</span>
            <span class="n">where</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    WHERE </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        AND &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">where_elements</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">where</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    SELECT </span><span class="si">{select_elements}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    FROM </span><span class="si">{from_elements}{where}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">select_elements</span><span class="o">=</span><span class="s2">&quot;,</span><span class="se">\n</span><span class="s2">        &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_elements</span><span class="p">),</span>
                <span class="n">from_elements</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">        &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">from_elements</span><span class="p">),</span>
                <span class="n">where</span><span class="o">=</span><span class="n">where</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">create_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">create_view</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sql</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">enforce_same_n_rows_as_base</span><span class="p">:</span>
            <span class="n">assert_view_has_same_num_rows</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basetable</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">viewname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine</span><span class="p">:</span> <span class="n">Engine</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">drop_view</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">record_lookup_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_tables</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lookup_tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">request_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">table</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_requests</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_requests</span><span class="p">[</span><span class="n">table</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># type: List[str]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_requests</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">record_lookup_table_keyfield</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">keyfield</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keyfield</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">keyfield</span> <span class="o">=</span> <span class="p">[</span><span class="n">keyfield</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_lookup_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">kf</span> <span class="ow">in</span> <span class="n">keyfield</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request_index</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">kf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">record_lookup_table_keyfields</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">table_keyfield_tuples</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span>
                <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span>
            <span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">table_keyfield_tuples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_lookup_table_keyfield</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_lookup_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_tables</span>

    <span class="k">def</span> <span class="nf">get_index_request_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_requests</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Transaction size-limiting class</span>
<span class="c1"># =============================================================================</span>

<span class="k">class</span> <span class="nc">TransactionSizeLimiter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span>
                 <span class="n">max_rows_before_commit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">max_bytes_before_commit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_rows_before_commit</span> <span class="o">=</span> <span class="n">max_rows_before_commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_bytes_before_commit</span> <span class="o">=</span> <span class="n">max_bytes_before_commit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bytes_in_transaction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rows_in_transaction</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">MultiTimerContext</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="n">TIMING_COMMIT</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bytes_in_transaction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rows_in_transaction</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_rows</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n_bytes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
               <span class="n">force_commit</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">force_commit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bytes_in_transaction</span> <span class="o">+=</span> <span class="n">n_bytes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rows_in_transaction</span> <span class="o">+=</span> <span class="n">n_rows</span>
        <span class="c1"># log.critical(</span>
        <span class="c1">#     &quot;adding {} rows, {} bytes, &quot;</span>
        <span class="c1">#     &quot;to make {} rows, {} bytes so far&quot;.format(</span>
        <span class="c1">#         n_rows, n_bytes,</span>
        <span class="c1">#         self._rows_in_transaction, self._bytes_in_transaction))</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_bytes_before_commit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bytes_in_transaction</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_bytes_before_commit</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Triggering early commit based on byte count (reached </span><span class="si">{}</span><span class="s2">, &quot;</span>
                <span class="s2">&quot;limit is </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">sizeof_fmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bytes_in_transaction</span><span class="p">),</span>
                    <span class="n">sizeof_fmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_bytes_before_commit</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_max_rows_before_commit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rows_in_transaction</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_rows_before_commit</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Triggering early commit based on row count (reached </span><span class="si">{}</span><span class="s2"> rows, &quot;</span>
                <span class="s2">&quot;limit is </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rows_in_transaction</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">_max_rows_before_commit</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Specification matching</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">_matches_tabledef</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tabledef</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">get_spec_match_regex</span><span class="p">(</span><span class="n">tabledef</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tr</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">matches_tabledef</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tabledef</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tabledef</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_matches_tabledef</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">tabledef</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">tabledef</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># list</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">_matches_tabledef</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">td</span><span class="p">)</span> <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">tabledef</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_matches_fielddef</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fielddef</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">column_id</span> <span class="o">=</span> <span class="n">split_db_schema_table_column</span><span class="p">(</span><span class="n">fielddef</span><span class="p">)</span>
    <span class="n">cr</span> <span class="o">=</span> <span class="n">get_spec_match_regex</span><span class="p">(</span><span class="n">column_id</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">column_id</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cr</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="n">get_spec_match_regex</span><span class="p">(</span><span class="n">column_id</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tr</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cr</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">matches_fielddef</span><span class="p">(</span><span class="n">table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">fielddef</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fielddef</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_matches_fielddef</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">fielddef</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">fielddef</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># list</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">_matches_fielddef</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">fd</span><span class="p">)</span> <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">fielddef</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># More SQL</span>
<span class="c1"># =============================================================================</span>

<div class="viewcode-block" id="sql_fragment_cast_to_int"><a class="viewcode-back" href="../../../autodoc/common/sql.html#crate_anon.common.sql.sql_fragment_cast_to_int">[docs]</a><span class="k">def</span> <span class="nf">sql_fragment_cast_to_int</span><span class="p">(</span><span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                             <span class="n">big</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">dialect</span><span class="p">:</span> <span class="n">Dialect</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                             <span class="n">viewmaker</span><span class="p">:</span> <span class="n">ViewMaker</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For Microsoft SQL Server.</span>
<span class="sd">    Conversion to INT:</span>
<span class="sd">    - http://stackoverflow.com/questions/2000045</span>
<span class="sd">    - http://stackoverflow.com/questions/14719760  # this one</span>
<span class="sd">    - http://stackoverflow.com/questions/14692131</span>
<span class="sd">      ... LIKE example.</span>
<span class="sd">      ... ISNUMERIC()</span>
<span class="sd">          https://msdn.microsoft.com/en-us/library/ms186272.aspx</span>
<span class="sd">          ... but that includes non-integer numerics</span>
<span class="sd">    - https://msdn.microsoft.com/en-us/library/ms174214(v=sql.120).aspx</span>
<span class="sd">      ... relates to the SQL Server Management Studio &quot;Find and Replace&quot;</span>
<span class="sd">          dialogue box, not to SQL itself!</span>
<span class="sd">    - http://stackoverflow.com/questions/29206404/mssql-regular-expression</span>

<span class="sd">    Note that the regex-like expression supported by LIKE is extremely limited.</span>
<span class="sd">    - https://msdn.microsoft.com/en-us/library/ms179859.aspx</span>
<span class="sd">    The only things supported are:</span>

<span class="sd">        %   any characters</span>
<span class="sd">        _   any single character</span>
<span class="sd">        []  single character in range or set, e.g. [a-f], [abcdef]</span>
<span class="sd">        [^] single character NOT in range or set, e.g. [^a-f], [abcdef]</span>

<span class="sd">    SQL Server does not support a REGEXP command directly.</span>

<span class="sd">    So the best bet is to have the LIKE clause check for a non-integer:</span>

<span class="sd">        CASE</span>
<span class="sd">            WHEN something LIKE &#39;%[^0-9]%&#39; THEN NULL</span>
<span class="sd">            ELSE CAST(something AS BIGINT)</span>
<span class="sd">        END</span>

<span class="sd">    ... which doesn&#39;t deal with spaces properly, but there you go.</span>
<span class="sd">    Could also strip whitespace left/right:</span>

<span class="sd">        CASE</span>
<span class="sd">            WHEN LTRIM(RTRIM(something)) LIKE &#39;%[^0-9]%&#39; THEN NULL</span>
<span class="sd">            ELSE CAST(something AS BIGINT)</span>
<span class="sd">        END</span>

<span class="sd">    Only works for positive integers.</span>
<span class="sd">    LTRIM/RTRIM are not ANSI SQL.</span>
<span class="sd">    Nor are unusual LIKE clauses; see</span>
<span class="sd">        http://stackoverflow.com/questions/712580/list-of-special-characters-for-sql-like-clause</span>

<span class="sd">    The other, for SQL Server 2012 or higher, is TRY_CAST:</span>

<span class="sd">        TRY_CAST(something AS BIGINT)</span>
<span class="sd">        ... returns NULL upon failure</span>
<span class="sd">        ... https://msdn.microsoft.com/en-us/library/hh974669.aspx</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
    <span class="n">inttype</span> <span class="o">=</span> <span class="s2">&quot;BIGINT&quot;</span> <span class="k">if</span> <span class="n">big</span> <span class="k">else</span> <span class="s2">&quot;INTEGER&quot;</span>
    <span class="k">if</span> <span class="n">dialect</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">viewmaker</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dialect</span> <span class="o">=</span> <span class="n">viewmaker</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">dialect</span>
    <span class="k">if</span> <span class="n">dialect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sql_server</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">supports_try_cast</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="n">sql_server</span> <span class="o">=</span> <span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;mssql&#39;</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="n">supports_try_cast</span> <span class="o">=</span> <span class="p">(</span><span class="n">sql_server</span> <span class="ow">and</span>
                             <span class="n">dialect</span><span class="o">.</span><span class="n">server_version_info</span> <span class="o">&gt;=</span> <span class="n">MS_2012_VERSION</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">supports_try_cast</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;TRY_CAST(</span><span class="si">{expr}</span><span class="s2"> AS </span><span class="si">{inttype}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span>
                                                      <span class="n">inttype</span><span class="o">=</span><span class="n">inttype</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sql_server</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;CASE WHEN LTRIM(RTRIM(</span><span class="si">{expr}</span><span class="s2">)) LIKE &#39;%[^0-9]%&#39; &quot;</span>
            <span class="s2">&quot;THEN NULL ELSE CAST(</span><span class="si">{expr}</span><span class="s2"> AS </span><span class="si">{inttype}</span><span class="s2">) END&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">expr</span><span class="o">=</span><span class="n">expr</span><span class="p">,</span> <span class="n">inttype</span><span class="o">=</span><span class="n">inttype</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Doesn&#39;t support negative integers.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># noinspection PyUnresolvedReferences</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Code not yet written for convert-to-int for &quot;</span>
                         <span class="s2">&quot;dialect </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dialect</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>


<span class="c1"># =============================================================================</span>
<span class="c1"># Abstracted SQL WHERE condition</span>
<span class="c1"># =============================================================================</span>

<span class="nd">@register_for_json</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">METHOD_PROVIDES_INIT_KWARGS</span><span class="p">)</span>
<span class="nd">@functools</span><span class="o">.</span><span class="n">total_ordering</span>
<span class="k">class</span> <span class="nc">WhereCondition</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># Ancillary class for building SQL WHERE expressions from our web forms.</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">column_id</span><span class="p">:</span> <span class="n">ColumnId</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">op</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">datatype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">value_or_values</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">raw_sql</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">from_table_for_raw_sql</span><span class="p">:</span> <span class="n">TableId</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_column_id</span> <span class="o">=</span> <span class="n">column_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_datatype</span> <span class="o">=</span> <span class="n">datatype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">value_or_values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multivalue</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_sql</span> <span class="o">=</span> <span class="n">raw_sql</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_from_table_for_raw_sql</span> <span class="o">=</span> <span class="n">from_table_for_raw_sql</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_sql</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="ow">in</span> <span class="n">SQL_OPS_VALUE_UNNECESSARY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_no_value</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">assert</span> <span class="n">value_or_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Superfluous value passed&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="ow">in</span> <span class="n">SQL_OPS_MULTIPLE_VALUES</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_multivalue</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_or_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;Need list&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_or_values</span><span class="p">,</span> <span class="nb">list</span><span class="p">),</span> <span class="s2">&quot;Need single value&quot;</span>  <span class="c1"># noqa</span>

    <span class="k">def</span> <span class="nf">init_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;column_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_id</span><span class="p">,</span>
            <span class="s1">&#39;op&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span>
            <span class="s1">&#39;datatype&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datatype</span><span class="p">,</span>
            <span class="s1">&#39;value_or_values&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">,</span>
            <span class="s1">&#39;raw_sql&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_sql</span><span class="p">,</span>
            <span class="s1">&#39;from_table_for_raw_sql&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_table_for_raw_sql</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;&lt;</span><span class="si">{qualname}</span><span class="s2">(&quot;</span>
            <span class="s2">&quot;column_id=</span><span class="si">{column_id}</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;op=</span><span class="si">{op}</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;datatype=</span><span class="si">{datatype}</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;value_or_values=</span><span class="si">{value_or_values}</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;raw_sql=</span><span class="si">{raw_sql}</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;from_table_for_raw_sql=</span><span class="si">{from_table_for_raw_sql}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;) at </span><span class="si">{addr}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">qualname</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
                <span class="n">column_id</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_column_id</span><span class="p">),</span>
                <span class="n">op</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">),</span>
                <span class="n">datatype</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_datatype</span><span class="p">),</span>
                <span class="n">value_or_values</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">),</span>
                <span class="n">raw_sql</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_sql</span><span class="p">),</span>
                <span class="n">from_table_for_raw_sql</span><span class="o">=</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_from_table_for_raw_sql</span><span class="p">),</span>
                <span class="n">addr</span><span class="o">=</span><span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;WhereCondition&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_raw_sql</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_raw_sql</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_column_id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_column_id</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_op</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">_value</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;WhereCondition&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_raw_sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span> <span class="o">&lt;</span>
            <span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_raw_sql</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_column_id</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_op</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">column_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ColumnId</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TableId</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_sql</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_table_for_raw_sql</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_id</span><span class="o">.</span><span class="n">table_id</span>

    <span class="k">def</span> <span class="nf">table_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">:</span> <span class="n">SqlGrammar</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_sql</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_raw_sql</span>

        <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_column_id</span><span class="o">.</span><span class="n">identifier</span><span class="p">(</span><span class="n">grammar</span><span class="p">)</span>
        <span class="n">op</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_value</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{col}</span><span class="s2"> </span><span class="si">{op}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datatype</span> <span class="ow">in</span> <span class="n">QB_STRING_TYPES</span><span class="p">:</span>
            <span class="n">element_converter</span> <span class="o">=</span> <span class="n">sql_string_literal</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datatype</span> <span class="o">==</span> <span class="n">QB_DATATYPE_DATE</span><span class="p">:</span>
            <span class="n">element_converter</span> <span class="o">=</span> <span class="n">sql_date_literal</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datatype</span> <span class="o">==</span> <span class="n">QB_DATATYPE_INTEGER</span><span class="p">:</span>
            <span class="n">element_converter</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datatype</span> <span class="o">==</span> <span class="n">QB_DATATYPE_FLOAT</span><span class="p">:</span>
            <span class="n">element_converter</span> <span class="o">=</span> <span class="nb">str</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Safe default</span>
            <span class="n">element_converter</span> <span class="o">=</span> <span class="n">sql_string_literal</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multivalue</span><span class="p">:</span>
            <span class="n">literal</span> <span class="o">=</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">element_converter</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                                              <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">literal</span> <span class="o">=</span> <span class="n">element_converter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">==</span> <span class="s1">&#39;MATCH&#39;</span><span class="p">:</span>  <span class="c1"># MySQL</span>
            <span class="k">return</span> <span class="s2">&quot;MATCH (</span><span class="si">{col}</span><span class="s2">) AGAINST (</span><span class="si">{val}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">literal</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_op</span> <span class="o">==</span> <span class="s1">&#39;CONTAINS&#39;</span><span class="p">:</span>  <span class="c1"># SQL Server</span>
            <span class="k">return</span> <span class="s2">&quot;CONTAINS(</span><span class="si">{col}</span><span class="s2">, </span><span class="si">{val}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">literal</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{col}</span><span class="s2"> </span><span class="si">{op}</span><span class="s2"> </span><span class="si">{val}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">op</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="n">literal</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># SQL formatting</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">format_sql_for_print</span><span class="p">(</span><span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># Remove blank lines and trailing spaces</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;    &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
                               <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sql</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()]))</span>
    <span class="c1"># Shift all lines left if they&#39;re left-padded</span>
    <span class="n">firstleftpos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">leftpos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
        <span class="n">firstleftpos</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">firstleftpos</span><span class="p">,</span> <span class="n">leftpos</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">firstleftpos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">firstleftpos</span><span class="p">:]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># Plain SQL types</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">is_sql_column_type_textual</span><span class="p">(</span><span class="n">column_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                               <span class="n">min_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">column_type</span> <span class="o">=</span> <span class="n">column_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">column_type</span> <span class="ow">in</span> <span class="n">SQLTYPES_TEXT</span><span class="p">:</span>
        <span class="c1"># A text type without a specific length</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">COLTYPE_WITH_ONE_INTEGER_REGEX</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">column_type</span><span class="p">)</span>
        <span class="n">basetype</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">length</span> <span class="o">&gt;=</span> <span class="n">min_length</span> <span class="ow">and</span> <span class="n">basetype</span> <span class="ow">in</span> <span class="n">SQLTYPES_TEXT</span>


<div class="viewcode-block" id="escape_quote_in_literal"><a class="viewcode-back" href="../../../autodoc/common/sql.html#crate_anon.common.sql.escape_quote_in_literal">[docs]</a><span class="k">def</span> <span class="nf">escape_quote_in_literal</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Escape &#39;. We could use &#39;&#39; or \&#39;.</span>
<span class="sd">    Let&#39;s use \. for consistency with percent escaping.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\&#39;&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="escape_percent_in_literal"><a class="viewcode-back" href="../../../autodoc/common/sql.html#crate_anon.common.sql.escape_percent_in_literal">[docs]</a><span class="k">def</span> <span class="nf">escape_percent_in_literal</span><span class="p">(</span><span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Escapes % by converting it to \%.</span>
<span class="sd">    Use this for LIKE clauses.</span>
<span class="sd">    http://dev.mysql.com/doc/refman/5.7/en/string-literals.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\%&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="escape_percent_for_python_dbapi"><a class="viewcode-back" href="../../../autodoc/common/sql.html#crate_anon.common.sql.escape_percent_for_python_dbapi">[docs]</a><span class="k">def</span> <span class="nf">escape_percent_for_python_dbapi</span><span class="p">(</span><span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Escapes % by converting it to %%.</span>
<span class="sd">    Use this for SQL within Python where % characters are used for argument</span>
<span class="sd">    placeholders.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sql</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%%</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="escape_sql_string_literal"><a class="viewcode-back" href="../../../autodoc/common/sql.html#crate_anon.common.sql.escape_sql_string_literal">[docs]</a><span class="k">def</span> <span class="nf">escape_sql_string_literal</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Escapes SQL string literal fragments against quotes and parameter</span>
<span class="sd">    substitution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">escape_percent_in_literal</span><span class="p">(</span><span class="n">escape_quote_in_literal</span><span class="p">(</span><span class="n">s</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">make_string_literal</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">escape_sql_string_literal</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">escape_sql_string_or_int_literal</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">make_string_literal</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<div class="viewcode-block" id="translate_sql_qmark_to_percent"><a class="viewcode-back" href="../../../autodoc/common/sql.html#crate_anon.common.sql.translate_sql_qmark_to_percent">[docs]</a><span class="k">def</span> <span class="nf">translate_sql_qmark_to_percent</span><span class="p">(</span><span class="n">sql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MySQL likes &#39;?&#39; as a placeholder.</span>
<span class="sd">    - https://dev.mysql.com/doc/refman/5.7/en/sql-syntax-prepared-statements.html</span>

<span class="sd">    Python DBAPI allows several: &#39;%s&#39;, &#39;?&#39;, &#39;:1&#39;, &#39;:name&#39;, &#39;%(name)s&#39;.</span>
<span class="sd">    - https://www.python.org/dev/peps/pep-0249/#paramstyle</span>

<span class="sd">    Django uses &#39;%s&#39;.</span>
<span class="sd">    - https://docs.djangoproject.com/en/1.8/topics/db/sql/</span>

<span class="sd">    Microsoft like &#39;?&#39;, &#39;@paramname&#39;, and &#39;:paramname&#39;.</span>
<span class="sd">    - https://msdn.microsoft.com/en-us/library/yy6y35y8(v=vs.110).aspx</span>

<span class="sd">    We need to parse SQL with argument placeholders.</span>
<span class="sd">    - See SqlGrammar classes, particularly: bind_parameter</span>

<span class="sd">    I prefer ?, because % is used in LIKE clauses, and the databases we&#39;re</span>
<span class="sd">    using like it.</span>

<span class="sd">    So:</span>
<span class="sd">    - We use %s when using cursor.execute() directly, via Django.</span>
<span class="sd">    - We use ? when talking to users, and SqlGrammar objects, so that the</span>
<span class="sd">      visual appearance matches what they expect from their database.</span>

<span class="sd">    This function translates SQL using ? placeholders to SQL using %s</span>
<span class="sd">    placeholders, without breaking literal &#39;?&#39; or &#39;%&#39;, e.g. inside string</span>
<span class="sd">    literals.</span>
<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa</span>
    <span class="c1"># 1. Escape % characters</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="n">escape_percent_for_python_dbapi</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="c1"># 2. Replace ? characters that are not within quotes with %s.</span>
    <span class="n">newsql</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">in_quotes</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">sql</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">:</span>
            <span class="n">in_quotes</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">in_quotes</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">in_quotes</span><span class="p">:</span>
            <span class="n">newsql</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newsql</span> <span class="o">+=</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">newsql</span></div>


<span class="n">_</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    _SQLTEST1 = &quot;SELECT a FROM b WHERE c=? AND d LIKE &#39;blah%&#39; AND e=&#39;?&#39;&quot;</span>
<span class="s2">    _SQLTEST2 = &quot;SELECT a FROM b WHERE c=</span><span class="si">%s</span><span class="s2"> AND d LIKE &#39;blah</span><span class="si">%%</span><span class="s2">&#39; AND e=&#39;?&#39;&quot;</span>
<span class="s2">    _SQLTEST3 = translate_sql_qmark_to_percent(_SQLTEST1)</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># Tests</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">unit_tests</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">matches_tabledef</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">,</span> <span class="s2">&quot;sometable&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">matches_tabledef</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">,</span> <span class="s2">&quot;some*&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">matches_tabledef</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">,</span> <span class="s2">&quot;*table&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">matches_tabledef</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">matches_tabledef</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">,</span> <span class="s2">&quot;s*e&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="ow">not</span> <span class="n">matches_tabledef</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">,</span> <span class="s2">&quot;x*y&quot;</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">matches_fielddef</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">,</span> <span class="s2">&quot;somefield&quot;</span><span class="p">,</span> <span class="s2">&quot;*.somefield&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">matches_fielddef</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">,</span> <span class="s2">&quot;somefield&quot;</span><span class="p">,</span> <span class="s2">&quot;sometable.somefield&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">matches_fielddef</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">,</span> <span class="s2">&quot;somefield&quot;</span><span class="p">,</span> <span class="s2">&quot;sometable.*&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">matches_fielddef</span><span class="p">(</span><span class="s2">&quot;sometable&quot;</span><span class="p">,</span> <span class="s2">&quot;somefield&quot;</span><span class="p">,</span> <span class="s2">&quot;somefield&quot;</span><span class="p">)</span>

    <span class="n">grammar</span> <span class="o">=</span> <span class="n">make_grammar</span><span class="p">(</span><span class="n">SqlaDialectName</span><span class="o">.</span><span class="n">MYSQL</span><span class="p">)</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT t1.c1, t2.c2 &quot;</span> \
          <span class="s2">&quot;FROM t1 INNER JOIN t2 ON t1.k = t2.k&quot;</span>
    <span class="n">parsed</span> <span class="o">=</span> <span class="n">grammar</span><span class="o">.</span><span class="n">get_select_statement</span><span class="p">()</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">parseAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">table_id</span> <span class="o">=</span> <span class="n">get_first_from_table</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>  <span class="c1"># noqa</span>
    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">table_id</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main_only_quicksetup_rootlogger</span><span class="p">()</span>
    <span class="n">unit_tests</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../../index.html">Table Of Contents</a></h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/overview.html">1. Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/package_elements.html">2. Package elements in brief</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/publications.html">3. Reference publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/installation.html">4. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/database_drivers.html">5. Databases and database drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../anonymisation/index.html">6. Anonymisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nlp/index.html">7. Natural language processing (NLP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_config/index.html">8. Configuring the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../website_using/index.html">9. Using the CRATE web interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/ancillary_tools.html">10. Ancillary tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/troubleshooting.html">11. Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/technical_notes.html">12. Technical notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/upgrading.html">13. Upgrading CRATE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc/tcpip_ports.html">14. Common relevant TCP/IP ports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/index.html">15. Automatic documentation of source code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">16. Change log/history</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../to_do.html">17. Things to do</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary.html">18. Abbreviations and glossary</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">CRATE  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, Rudolf Cardinal.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.5.
    </div>
  </body>
</html>